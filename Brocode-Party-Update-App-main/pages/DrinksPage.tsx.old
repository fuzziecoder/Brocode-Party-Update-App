import React, { useEffect, useState, useCallback, useRef } from "react";
import { useAuth } from "../hooks/useAuth";
import { useNotifications } from "../contexts/NotificationsContext";
import {
  UserRole, Spot, Drink, PaymentStatus, Cigarette, Food, DrinkBrand,
  UserDrinkSelection,
  SpotSponsor,
} from "../types";
import Card from "../components/common/Card";
import Button from "../components/common/Button";
import Modal from "../components/common/Modal";
import Input from "../components/common/Input";
import { spotService, paymentService, drinkService, cigaretteService, foodService, drinkBrandService, userDrinkSelectionService, sponsorService, billService } from "../services/database";
import { supabase } from "../services/supabase";
import { Plus, ThumbsUp, Trash2, Loader2, Image as ImageIcon, X, Camera, ShoppingCart, Minus, Check, Wine, Search, Menu, ArrowLeft, Star, Edit, Utensils, Download, FileText, CheckCircle2, Crown } from "lucide-react";
import ShinyText from "../components/common/ShinyText";
import CircularText from "../components/common/CircularText";
import PixelCard from "../components/common/PixelCard";
import SponsorBadge from "../components/common/SponsorBadge";
import { useNavigate } from "react-router-dom";

const DrinksPage: React.FC = () => {
  const { profile } = useAuth();
  const { notify } = useNotifications();
  const navigate = useNavigate();
  const [spot, setSpot] = useState<Spot | null>(null);
  const [drinks, setDrinks] = useState<Drink[]>([]);
  const [cigarettes, setCigarettes] = useState<Cigarette[]>([]);
  const [foods, setFoods] = useState<Food[]>([]);
  const [drinkBrands, setDrinkBrands] = useState<DrinkBrand[]>([]);
  const [userSelections, setUserSelections] = useState<UserDrinkSelection[]>([]);
  const [loading, setLoading] = useState(true);
  const [isPaid, setIsPaid] = useState(false);
  const [pageError, setPageError] = useState<string | null>(null);

  // UI State
  const [activeSection, setActiveSection] = useState<'browse' | 'checkout' | 'detail'>('browse');
  const [activeType, setActiveType] = useState<'drinks' | 'food' | 'cigarette'>('drinks');
  const [selectedCategory, setSelectedCategory] = useState<string>('all');
  const [searchQuery, setSearchQuery] = useState("");
  const [selectedProduct, setSelectedProduct] = useState<DrinkBrand | Drink | Cigarette | Food | null>(null);
  const [orderComment, setOrderComment] = useState("");

  // Modals
  const [isDrinkModalOpen, setIsDrinkModalOpen] = useState(false);
  const [isCigaretteModalOpen, setIsCigaretteModalOpen] = useState(false);
  const [isFoodModalOpen, setIsFoodModalOpen] = useState(false);
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [editingItem, setEditingItem] = useState<Drink | Cigarette | Food | null>(null);
  const [newDrinkName, setNewDrinkName] = useState("");
  const [newDrinkImage, setNewDrinkImage] = useState("");
  const [newDrinkImagePreview, setNewDrinkImagePreview] = useState<string | null>(null);
  const [newCigaretteImage, setNewCigaretteImage] = useState<string | null>(null);
  const [newCigaretteImagePreview, setNewCigaretteImagePreview] = useState<string | null>(null);
  const [newCigaretteName, setNewCigaretteName] = useState("");
  const [newFoodName, setNewFoodName] = useState("");
  const [newFoodImage, setNewFoodImage] = useState<string | null>(null);
  const [newFoodImagePreview, setNewFoodImagePreview] = useState<string | null>(null);
  const [userVotedDrinks, setUserVotedDrinks] = useState<Set<string>>(new Set());
  const drinkImageInputRef = useRef<HTMLInputElement>(null);
  const cigaretteImageInputRef = useRef<HTMLInputElement>(null);
  const foodImageInputRef = useRef<HTMLInputElement>(null);

  const [editingPriceItem, setEditingPriceItem] = useState<{ type: 'drink' | 'food' | 'cigarette'; id: string } | null>(null);
  const [priceInput, setPriceInput] = useState("");
  const [currentUserUUID, setCurrentUserUUID] = useState<string | null>(null);
  const [isExportMenuOpen, setIsExportMenuOpen] = useState(false);
  const [isBillModalOpen, setIsBillModalOpen] = useState(false);
  const [spotSponsor, setSpotSponsor] = useState<SpotSponsor | null>(null);
  const [billConfirmations, setBillConfirmations] = useState<Record<string, boolean>>({});

  const isAdmin = profile?.role === UserRole.ADMIN;

  // Helper function to get UUID from profile ID
  const getUserIdAsUUID = useCallback(async (profileId: string): Promise<string> => {
    if (!profile) {
      throw new Error('No user profile available');
    }

    if (profileId.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
      return profileId;
    }

    const cleanPhone = profile.phone ? profile.phone.replace(/\D/g, '') : '';
    let dbProfile = null;

    if (cleanPhone) {
      const { data, error } = await supabase
        .from('profiles')
        .select('id')
        .eq('phone', cleanPhone)
        .maybeSingle();
      if (!error && data) dbProfile = data;
    }

    if (!dbProfile && profile.email) {
      const { data, error } = await supabase
        .from('profiles')
        .select('id')
        .eq('email', profile.email)
        .maybeSingle();
      if (!error && data) dbProfile = data;
    }

    if (!dbProfile && profile.username) {
      const { data, error } = await supabase
        .from('profiles')
        .select('id')
        .eq('username', profile.username)
        .maybeSingle();
      if (!error && data) dbProfile = data;
    }

    if (dbProfile) return dbProfile.id;
    return profileId;
  }, [profile]);

  // Fetch current user's UUID on mount
  useEffect(() => {
    const fetchUserUUID = async () => {
      if (profile) {
        try {
          const uuid = await getUserIdAsUUID(profile.id);
          setCurrentUserUUID(uuid);
          console.log('âœ… Current user UUID set:', uuid, 'from profile.id:', profile.id);
        } catch (err) {
          console.error('Error getting user UUID:', err);
          setCurrentUserUUID(profile.id);
        }
      }
    };
    fetchUserUUID();
  }, [profile, getUserIdAsUUID]);

  const fetchData = useCallback(async () => {
    if (!profile) {
      setLoading(false);
      return;
    }

    try {
      setPageError(null);
      const spotData = await spotService.getUpcomingSpot();
      setSpot(spotData);

      if (spotData) {
        let userId: string;
        try {
          userId = await getUserIdAsUUID(profile.id);
        } catch (err) {
          console.error('Error getting user UUID:', err);
          userId = profile.id;
        }

        const payments = await paymentService.getPayments(spotData.id);
        const userPayment = payments.find((p) => p.user_id === userId);
        const paidStatus = userPayment?.status === PaymentStatus.PAID;
        setIsPaid(paidStatus);

        if (paidStatus) {
          try {
            const [drinksData, cigarettesData, foodsData, brandsData, selectionsData, sponsorData, confirmationsData] = await Promise.all([
              drinkService.getDrinks(spotData.id).catch((err) => {
                console.error('Error fetching drinks:', err);
                return [];
              }),
              cigaretteService.getCigarettes(spotData.id).catch((err) => {
                console.error('Error fetching cigarettes:', err);
                return [];
              }),
              foodService.getFoods(spotData.id).catch((err) => {
                console.error('Error fetching foods:', err);
                return [];
              }),
              drinkBrandService.getDrinkBrands().catch((err) => {
                console.error('Error fetching drink brands:', err);
                return [];
              }),
              userDrinkSelectionService.getUserSelections(spotData.id, userId).catch((err) => {
                console.error('Error fetching selections:', err);
                return [];
              }),
              sponsorService.getSponsor(spotData.id).catch((err) => {
                console.error('Error fetching sponsor:', err);
                return null;
              }),
              billService.getAllBillConfirmations(spotData.id).catch((err) => {
                console.error('Error fetching confirmations:', err);
                return {};
              }),
            ]);
            setDrinks(drinksData || []);
            setCigarettes(cigarettesData || []);
            setFoods(foodsData || []);
            setDrinkBrands(brandsData || []);
            setUserSelections(selectionsData || []);
            setSpotSponsor(sponsorData);
            setBillConfirmations(confirmationsData || {});
          } catch (fetchError: any) {
            console.error('Error fetching data:', fetchError);
            setDrinks([]);
            setCigarettes([]);
            setFoods([]);
            setDrinkBrands([]);
            setUserSelections([]);
            setPageError(fetchError.message || 'Error loading drinks data. Please try again.');
          }
        } else {
          setDrinks([]);
          setCigarettes([]);
          setFoods([]);
          setDrinkBrands([]);
          setUserSelections([]);
        }
      } else {
        setDrinks([]);
        setIsPaid(false);
      }
    } catch (error: any) {
      console.error("Error loading drinks data:", error);
      setDrinks([]);
      setCigarettes([]);
      setFoods([]);
      setDrinkBrands([]);
      setUserSelections([]);
      setIsPaid(false);

      if (error.message?.includes('does not exist') ||
        error.message?.includes('relation') ||
        error.code === '42P01') {
        setPageError('Database tables not found. Please run migration SQL files in Supabase.');
      } else {
        setPageError(error.message || 'Something went wrong while loading drinks section.');
      }
    } finally {
      setLoading(false);
    }
  }, [profile, getUserIdAsUUID]);

  useEffect(() => {
    fetchData();

    if (spot && isPaid) {
      const drinksChannel = supabase
        .channel(`drinks-${spot.id}`)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'drinks', filter: `spot_id=eq.${spot.id}` }, () => fetchData())
        .subscribe();

      const selectionsChannel = supabase
        .channel(`selections-${spot.id}`)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'user_drink_selections', filter: `spot_id=eq.${spot.id}` }, () => fetchData())
        .subscribe();

      const sponsorChannel = sponsorService.subscribeToSponsors(spot.id, () => fetchData());
      const paymentsChannel = paymentService.subscribeToPayments(spot.id, () => fetchData());

      return () => {
        supabase.removeChannel(drinksChannel);
        supabase.removeChannel(selectionsChannel);
        supabase.removeChannel(sponsorChannel);
        supabase.removeChannel(paymentsChannel);
      };
    }
  }, [fetchData, spot?.id, isPaid]);

  // Update voted drinks - MUST be before conditional returns
  useEffect(() => {
    const updateVotedDrinks = async () => {
      if (!profile || drinks.length === 0) {
        setUserVotedDrinks(new Set());
        return;
      }
      try {
        const userId = await getUserIdAsUUID(profile.id);
        const voted = new Set(
          drinks
            .filter(d => d && d.voted_by && Array.isArray(d.voted_by) && d.voted_by.includes(userId))
            .map(d => d.id)
        );
        setUserVotedDrinks(voted);
      } catch (err) {
        console.error('Error updating voted drinks:', err);
        setUserVotedDrinks(new Set());
      }
    };
    if (profile) {
      updateVotedDrinks();
    }
  }, [drinks, profile, getUserIdAsUUID]);

  const handleDrinkImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        const result = reader.result as string;
        setNewDrinkImagePreview(result);
        setNewDrinkImage(result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleCigaretteImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        const result = reader.result as string;
        setNewCigaretteImagePreview(result);
        setNewCigaretteImage(result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleFoodImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        const result = reader.result as string;
        setNewFoodImagePreview(result);
        setNewFoodImage(result);
      };
      reader.readAsDataURL(file);
    }
  };

  const handleAddDrink = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!spot || !profile || !newDrinkName.trim()) return;

    try {
      const userId = await getUserIdAsUUID(profile.id);
      const created = await drinkService.createDrink({
        spot_id: spot.id,
        name: newDrinkName.trim(),
        image_url: newDrinkImage || undefined,
        suggested_by: userId,
      });

      // Add to local state so it appears immediately
      setDrinks((prev) => {
        // avoid duplicates
        if (!created) return prev || [];
        return [...(prev || []), created];
      });

      setNewDrinkName("");
      setNewDrinkImage("");
      setNewDrinkImagePreview(null);
      setIsDrinkModalOpen(false);
      // still refresh full data in background
      fetchData().catch((err) => console.error('fetchData after createDrink failed', err));
    } catch (error: any) {
      console.error('Error adding drink:', error);
      alert(`Failed to add drink: ${error.message || 'Please try again.'}`);
    }
  };

  const handleAddCigarette = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!spot || !profile || !newCigaretteImage || !newCigaretteName.trim()) {
      alert('Please provide both cigarette name and image');
      return;
    }

    try {
      const userId = await getUserIdAsUUID(profile.id);
      const created = await cigaretteService.createCigarette({
        spot_id: spot.id,
        name: newCigaretteName.trim(),
        image_url: newCigaretteImage,
        added_by: userId,
      });

      setCigarettes((prev) => {
        if (!created) return prev || [];
        return [...(prev || []), created];
      });

      setNewCigaretteImage(null);
      setNewCigaretteImagePreview(null);
      setNewCigaretteName("");
      setIsCigaretteModalOpen(false);
      fetchData().catch((err) => console.error('fetchData after createCigarette failed', err));
    } catch (error: any) {
      console.error('Error adding cigarette:', error);
      alert(`Failed to add cigarette: ${error.message || 'Please try again.'}`);
    }
  };

  const handleAddFood = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!spot || !profile || !newFoodImage || !newFoodName.trim()) return;

    try {
      const userId = await getUserIdAsUUID(profile.id);
      const created = await foodService.createFood({
        spot_id: spot.id,
        name: newFoodName.trim(),
        image_url: newFoodImage,
        added_by: userId,
      });

      setFoods((prev) => {
        if (!created) return prev || [];
        return [...(prev || []), created];
      });

      setNewFoodImage(null);
      setNewFoodImagePreview(null);
      setNewFoodName("");
      setIsFoodModalOpen(false);
      fetchData().catch((err) => console.error('fetchData after createFood failed', err));
    } catch (error: any) {
      console.error('Error adding food:', error);
      alert(`Failed to add food: ${error.message || 'Please try again.'}`);
    }
  };

  const handleDeleteFood = async (foodId: string) => {
    if (!foodId || !confirm("Are you sure you want to delete this food?")) return;

    try {
      await foodService.deleteFood(foodId);
      await fetchData();
    } catch (error: any) {
      console.error('Error deleting food:', error);
      alert(`Failed to delete food: ${error.message || 'Please try again.'}`);
    }
  };

  const handleEditItem = (item: Drink | Cigarette | Food) => {
    setEditingItem(item);
    if ('votes' in item) {
      // It's a Drink
      setNewDrinkName(item.name);
      setNewDrinkImage(item.image_url);
      setNewDrinkImagePreview(item.image_url || null);
    } else if ('name' in item && 'added_by' in item) {
      if ('spot_id' in item && !('suggested_by' in item)) {
        // It's Food
        setNewFoodName(item.name);
        setNewFoodImage(item.image_url);
        setNewFoodImagePreview(item.image_url);
      } else {
        // It's Cigarette
        setNewCigaretteName(item.name);
        setNewCigaretteImage(item.image_url);
        setNewCigaretteImagePreview(item.image_url);
      }
    }
    setIsEditModalOpen(true);
  };

  const handleUpdateItem = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!editingItem || !profile) return;

    try {
      if ('votes' in editingItem) {
        // Update Drink
        await drinkService.updateDrink(editingItem.id, {
          name: newDrinkName.trim(),
          image_url: newDrinkImage || undefined,
        });
      } else if ('name' in editingItem && 'added_by' in editingItem) {
        // Check if it's Food or Cigarette by checking if it has suggested_by (Drink) or not
        if ('suggested_by' in editingItem) {
          // This shouldn't happen, but handle it
        } else {
          // It's either Food or Cigarette - check by trying to update as Food first
          const item = editingItem as Food | Cigarette;
          if (newFoodName && newFoodImage) {
            // Update Food
            await foodService.updateFood(item.id, {
              name: newFoodName.trim(),
              image_url: newFoodImage || undefined,
            });
          } else if (newCigaretteName || newCigaretteImage) {
            // Update Cigarette
            await cigaretteService.updateCigarette(item.id, {
              name: newCigaretteName.trim(),
              image_url: newCigaretteImage || undefined,
            });
          }
        }
      }

      // Reset form
      setEditingItem(null);
      setIsEditModalOpen(false);
      setNewDrinkName("");
      setNewDrinkImage("");
      setNewDrinkImagePreview(null);
      setNewCigaretteImage(null);
      setNewCigaretteImagePreview(null);
      setNewCigaretteName("");
      setNewFoodName("");
      setNewFoodImage(null);
      setNewFoodImagePreview(null);
      await fetchData();
    } catch (error: any) {
      console.error('Error updating item:', error);
      alert(`Failed to update: ${error.message || 'Please try again.'}`);
    }
  };

  const isUserOwner = useCallback((item: Drink | Cigarette | Food): boolean => {
    if (!currentUserUUID) {
      return false;
    }

    // Check if the item's creator matches the current user
    if ('suggested_by' in item) {
      // For drinks
      const isOwner = item.suggested_by === currentUserUUID;
      if (isOwner) {
        console.log('âœ… User owns this drink:', item.id);
      }
      return isOwner;
    }
    if ('added_by' in item) {
      // For cigarettes and food
      const isOwner = item.added_by === currentUserUUID;
      if (isOwner) {
        console.log('âœ… User owns this item:', item.id);
      }
      return isOwner;
    }
    return false;
  }, [currentUserUUID]);

  const handleDeleteCigarette = async (cigaretteId: string) => {
    if (!cigaretteId || !confirm("Are you sure you want to delete this cigarette?")) return;

    try {
      await cigaretteService.deleteCigarette(cigaretteId);
      await fetchData();
    } catch (error: any) {
      console.error('Error deleting cigarette:', error);
      alert(`Failed to delete cigarette: ${error.message || 'Please try again.'}`);
    }
  };

  const handleVote = async (drinkId: string) => {
    if (!profile || !drinkId) return;

    try {
      const userId = await getUserIdAsUUID(profile.id);
      await drinkService.voteForDrink(drinkId, userId);
      await fetchData();
    } catch (error: any) {
      console.error('Error voting:', error);
      alert(`Failed to vote: ${error.message || 'Please try again.'}`);
    }
  };

  const handleDeleteDrink = async (drinkId: string) => {
    if (!drinkId || !confirm("Are you sure you want to delete this drink?")) return;

    try {
      await drinkService.deleteDrink(drinkId);
      await fetchData();
    } catch (error: any) {
      console.error('Error deleting drink:', error);
      alert(`Failed to delete drink: ${error.message || 'Please try again.'}`);
    }
  };

  const handleAddToCart = async (brand: DrinkBrand, quantity: number = 1) => {
    if (!spot || !profile) return;
    try {
      const userId = await getUserIdAsUUID(profile.id);
      await userDrinkSelectionService.upsertSelection({
        spot_id: spot.id,
        user_id: userId,
        drink_brand_id: brand.id,
        quantity: quantity,
        unit_price: brand.base_price,
      });
      await fetchData();
    } catch (error: any) {
      console.error('Error adding to cart:', error);
      alert(`Failed to add drink: ${error.message || 'Please try again.'}`);
    }
  };

  const handleUpdateQuantity = async (selection: UserDrinkSelection, newQuantity: number) => {
    if (newQuantity <= 0) {
      await userDrinkSelectionService.deleteSelection(selection.id);
    } else {
      await userDrinkSelectionService.upsertSelection({
        spot_id: selection.spot_id,
        user_id: selection.user_id,
        drink_brand_id: selection.drink_brand_id,
        quantity: newQuantity,
        unit_price: selection.unit_price,
      });
    }
    await fetchData();
  };

  const handleRemoveSelection = async (selectionId: string) => {
    if (!confirm("Remove this drink from your order?")) return;
    try {
      await userDrinkSelectionService.deleteSelection(selectionId);
      await fetchData();
    } catch (error: any) {
      console.error('Error removing selection:', error);
      alert(`Failed to remove: ${error.message || 'Please try again.'}`);
    }
  };

  const handleProductClick = (product: DrinkBrand | Drink | Cigarette) => {
    setSelectedProduct(product);
    setActiveSection('detail');
  };

  const handlePayNow = async () => {
    // Handle payment logic here
    alert('Payment functionality will be integrated here');
  };

  const handleUpdatePrice = async (itemId: string, type: 'drink' | 'food' | 'cigarette', price: number) => {
    if (!isAdmin) return;

    try {
      if (type === 'drink') {
        await drinkService.updateDrink(itemId, { price });
      } else if (type === 'food') {
        await foodService.updateFood(itemId, { price });
      } else if (type === 'cigarette') {
        await cigaretteService.updateCigarette(itemId, { price });
      }
      setEditingPriceItem(null);
      setPriceInput("");
      await fetchData();
    } catch (error: any) {
      console.error('Error updating price:', error);
      // Check if error is about missing column
      if (error.message?.includes('column') && error.message?.includes('does not exist')) {
        alert('Price column not found. Please run the migration: supabase_migration_prices.sql in your Supabase SQL Editor.');
      } else {
        alert(`Failed to update price: ${error.message || 'Please try again.'}`);
      }
    }
  };

  const totalCartAmount = userSelections.reduce((sum, sel) => sum + sel.total_price, 0);
  const cartItemCount = userSelections.reduce((sum, sel) => sum + sel.quantity, 0);

  const categories = ['all', 'wine', 'beer', 'spirits'];
  const filteredBrands = selectedCategory === 'all'
    ? drinkBrands.filter(b => activeType === 'drinks' && b.category !== 'soft_drink')
    : drinkBrands.filter(b => {
      if (activeType !== 'drinks') return false;
      const categoryMap: Record<string, string[]> = {
        'wine': ['wine'],
        'beer': ['beer'],
        'spirits': ['whiskey', 'vodka', 'rum', 'cocktail']
      };
      return categoryMap[selectedCategory]?.includes(b.category) || false;
    });

  // Filter by search query
  const searchFilteredBrands = filteredBrands.filter(brand =>
    brand.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    brand.description?.toLowerCase().includes(searchQuery.toLowerCase())
  );

  const hasUserVoted = (drink: Drink) => {
    if (!drink || !drink.id) return false;
    return userVotedDrinks.has(drink.id);
  };

  // Export data to Excel (CSV format)
  const exportToExcel = () => {
    if (!isAdmin) return;

    // Group data by user
    const userDataMap = new Map<string, {
      userId: string;
      username: string;
      name: string;
      drinks: string[];
      foods: string[];
      cigarettes: string[];
    }>();

    // Process drinks
    drinks.forEach(drink => {
      const userId = drink.suggested_by;
      const existingUser = drink.profiles;
      if (existingUser) {
        if (!userDataMap.has(userId)) {
          userDataMap.set(userId, {
            userId,
            username: (existingUser as any).username || 'Unknown',
            name: existingUser.name || 'Unknown',
            drinks: [],
            foods: [],
            cigarettes: []
          });
        }
        userDataMap.get(userId)?.drinks.push(drink.name);
      }
    });

    // Process foods
    foods.forEach(food => {
      const userId = food.added_by;
      const existingUser = food.profiles;
      if (existingUser) {
        if (!userDataMap.has(userId)) {
          userDataMap.set(userId, {
            userId,
            username: (existingUser as any).username || 'Unknown',
            name: existingUser.name || 'Unknown',
            drinks: [],
            foods: [],
            cigarettes: []
          });
        }
        userDataMap.get(userId)?.foods.push(food.name);
      }
    });

    // Process cigarettes
    cigarettes.forEach(cig => {
      const userId = cig.added_by;
      const existingUser = cig.profiles;
      if (existingUser) {
        if (!userDataMap.has(userId)) {
          userDataMap.set(userId, {
            userId,
            username: (existingUser as any).username || 'Unknown',
            name: existingUser.name || 'Unknown',
            drinks: [],
            foods: [],
            cigarettes: []
          });
        }
        userDataMap.get(userId)?.cigarettes.push(cig.name);
      }
    });

    // Create CSV content
    let csvContent = "User ID,Username,Name,Drinks,Foods,Cigarettes\n";

    userDataMap.forEach((userData) => {
      const drinksStr = userData.drinks.length > 0 ? userData.drinks.join('; ') : 'None';
      const foodsStr = userData.foods.length > 0 ? userData.foods.join('; ') : 'None';
      const cigarettesStr = userData.cigarettes.length > 0 ? userData.cigarettes.join('; ') : 'Not needed for me';

      csvContent += `"${userData.userId}","${userData.username}","${userData.name}","${drinksStr}","${foodsStr}","${cigarettesStr}"\n`;
    });

    // Create and download the file
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `brocode_orders_${spot?.location || 'spot'}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  // Safety check: don't render if profile is not available yet
  if (!profile) {
    return (
      <div className="p-8 text-center">
        <Loader2 className="animate-spin mx-auto mb-4" size={32} />
        <p>Loading user data...</p>
      </div>
    );
  }

  if (loading) {
    return (
      <div className="p-8 text-center min-h-screen flex items-center justify-center">
        <div>
          <Loader2 className="animate-spin mx-auto mb-4" size={32} />
          <p>Loading bar menu...</p>
        </div>
      </div>
    );
  }

  if (pageError) {
    return (
      <div className="p-8 text-center">
        <Card className="p-8 max-w-2xl mx-auto">
          <div className="mb-4">
            <span className="text-6xl">âš ï¸</span>
          </div>
          <h2 className="text-xl font-semibold mb-4 text-red-400">Drinks Section Error</h2>
          <p className="text-gray-300 mb-6 whitespace-pre-line">{pageError}</p>
          <div className="space-y-3">
            <Button onClick={() => {
              setPageError(null);
              fetchData();
            }}>
              Try Again
            </Button>
            <Button
              variant="secondary"
              onClick={() => window.location.reload()}
              className="ml-2"
            >
              Refresh Page
            </Button>
          </div>
        </Card>
      </div>
    );
  }

  if (!spot) {
    return (
      <Card>
        <p className="text-center text-gray-400">No upcoming spot available.</p>
      </Card>
    );
  }

  if (!isPaid) {
    return (
      <div className="space-y-6 pb-20 max-w-6xl mx-auto px-4">
        <h1 className="text-2xl md:text-3xl font-bold">Bar Menu</h1>
        <Card className="p-8 text-center">
          <p className="text-gray-400 mb-4">You need to complete payment first to access the bar.</p>
          <Button onClick={() => window.location.href = '/dashboard/payment'}>Go to Payment</Button>
        </Card>
      </div>
    );
  }

  // BROWSE / MENU SECTION
  if (activeSection === 'browse') {
    return (
      <div className="min-h-screen bg-black text-white p-8 flex flex-col items-center justify-center">
        <h1 className="text-3xl font-bold mb-4 text-amber-500">Drinks Menu Updating...</h1>
        <p className="text-zinc-400 mb-8">We are applying updates to the menu layout. Please check back shortly.</p>
        <Button onClick={() => window.location.reload()}>Refresh Page</Button>
      </div>
    );
  }
  /*
    return (
      <>
        <div className="min-h-screen bg-black text-white pb-24">
          {/* Header */}
<div className="sticky top-0 z-10 bg-black border-b border-zinc-800 px-4 py-3">
  <div className="flex items-center justify-between max-w-7xl mx-auto">
    <div className="flex items-center gap-2">
      <span className="text-sm font-medium text-zinc-400">{spot.location}</span>
    </div>
    <div className="flex items-center gap-2">
      <button
        className="p-2 hover:bg-zinc-900 rounded-lg transition-colors"
        onClick={() => setIsBillModalOpen(true)}
        title="View Bill"
      >
        <FileText size={20} className="text-indigo-400" />
      </button>
      <div className="relative">
        <button
          className="p-2 hover:bg-zinc-900 rounded-lg"
          onClick={() => setIsExportMenuOpen(!isExportMenuOpen)}
        >
          <Menu size={20} />
        </button>
        {/* Export Menu Dropdown */}
        {isExportMenuOpen && isAdmin && (
          <div className="absolute right-0 top-12 bg-zinc-900 border border-zinc-700 rounded-lg shadow-xl z-50 min-w-[200px]">
            <button
              onClick={() => {
                exportToExcel();
                setIsExportMenuOpen(false);
              }}
              className="w-full flex items-center gap-3 px-4 py-3 hover:bg-zinc-800 text-white text-sm"
            >
              <Download size={18} />
              Download Excel Report
            </button>
          </div>
        )}
      </div>
    </div>
  </div>
</div>
        </div >
  {/* Sponsor Banner */ }
{
  spotSponsor && spotSponsor.profiles && (
    <div className="mt-4 p-3 rounded-xl bg-gradient-to-r from-amber-500/20 to-yellow-600/20 border border-amber-500/50 flex items-center gap-3">
      <div className="p-2 bg-amber-500/20 rounded-full">
        <Crown size={20} className="text-amber-400" />
      </div>
      <div>
        <p className="text-amber-200 text-xs font-bold uppercase tracking-widest">Sponsored Event</p>
        <p className="text-white text-sm">
          <span className="font-bold">{spotSponsor.profiles.name}</span> is covering the bill! {spotSponsor.message && `"${spotSponsor.message}"`}
        </p>
      </div>
      <div className="ml-auto">
        <SponsorBadge size="md" animate />
      </div>
    </div>
  )
}


<div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
  {/* Title */}
  <h1 className="text-2xl md:text-3xl font-bold">What Would You Like?</h1>

  {/* Search Bar */}
  <div className="relative">
    <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400" size={20} />
    <input
      type="text"
      placeholder="Search..."
      value={searchQuery}
      onChange={(e) => setSearchQuery(e.target.value)}
      className="w-full pl-10 pr-4 py-3 bg-zinc-900 border border-zinc-800 rounded-lg text-white placeholder-zinc-500 focus:outline-none focus:border-indigo-500"
    />
  </div>

  {/* Type Toggle Pills */}
  <div className="flex gap-2">
    {(['drinks', 'food', 'cigarette'] as const).map((type) => (
      <button
        key={type}
        onClick={() => setActiveType(type)}
        className={`px-6 py-2 rounded-full font-medium transition-colors ${activeType === type
          ? 'bg-white text-black'
          : 'bg-zinc-900 text-zinc-400 border border-zinc-800'
          }`}
      >
        {type.charAt(0).toUpperCase() + type.slice(1)}
      </button>
    ))}
  </div>

  {/* Category Tabs */}
  {activeType === 'drinks' && (
    <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
      {categories.map(cat => (
        <button
          key={cat}
          onClick={() => setSelectedCategory(cat)}
          className={`px-4 py-2 rounded-lg font-medium whitespace-nowrap transition-colors ${selectedCategory === cat
            ? 'bg-indigo-600 text-white'
            : 'bg-zinc-900 text-zinc-400 border border-zinc-800'
            }`}
        >
          {cat === 'all' ? 'All' : cat.charAt(0).toUpperCase() + cat.slice(1)}
        </button>
      ))}
    </div>
  )}

  {/* Admin View - Grouped by Username */}
  {isAdmin && (
    <div className="space-y-6">
      {activeType === 'drinks' && (
        <div className="space-y-4">
          {(() => {
            // Group drinks by username
            const groupedByUser: Record<string, Drink[]> = {};
            drinks.forEach(drink => {
              const username = drink.profiles?.name || 'Unknown';
              if (!groupedByUser[username]) groupedByUser[username] = [];
              groupedByUser[username].push(drink);
            });

            return Object.entries(groupedByUser).map(([username, userDrinks]) => (
              <div key={username} className="space-y-2">
                <h3 className="text-lg font-semibold text-zinc-300">{username}</h3>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                  {userDrinks.map(drink => (
                    <Card key={drink.id} className="p-4 bg-zinc-900 border-zinc-800">
                      <div className="relative mb-3">
                        {drink.image_url ? (
                          <img src={drink.image_url} alt={drink.name} className="w-full h-32 object-cover rounded-lg" />
                        ) : (
                          <div className="w-full h-32 bg-zinc-800 rounded-lg flex items-center justify-center">
                            <Wine size={32} className="text-zinc-500" />
                          </div>
                        )}
                      </div>
                      <h3 className="font-semibold text-sm mb-2">{drink.name}</h3>
                      {editingPriceItem?.id === drink.id && editingPriceItem?.type === 'drink' ? (
                        <div className="flex flex-col sm:flex-row gap-2 w-full">
                          <input
                            type="number"
                            value={priceInput}
                            onChange={(e) => setPriceInput(e.target.value)}
                            placeholder="Price"
                            className="flex-1 px-3 py-2 bg-zinc-800 border border-zinc-700 rounded text-white text-sm focus:outline-none focus:border-indigo-500"
                          />
                          <button
                            onClick={() => handleUpdatePrice(drink.id, 'drink', parseFloat(priceInput))}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded text-sm font-medium transition-colors"
                          >
                            Save
                          </button>
                        </div>
                      ) : (
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-zinc-400">{drink.price ? `Rs.${drink.price}` : 'No price'}</span>
                          <div className="flex gap-2">
                            <button
                              onClick={() => {
                                setEditingPriceItem({ type: 'drink', id: drink.id });
                                setPriceInput(drink.price?.toString() || '');
                              }}
                              className="text-indigo-400 text-sm hover:text-indigo-300"
                            >
                              Set Price
                            </button>
                            {isUserOwner(drink) && (
                              <button
                                onClick={() => handleDeleteDrink(drink.id)}
                                className="text-red-400 hover:text-red-300 transition-colors"
                                title="Delete"
                              >
                                <Trash2 size={16} />
                              </button>
                            )}
                          </div>
                        </div>
                      )}
                    </Card>
                  ))}
                </div>
              </div>
            ));
          })()}
        </div>
      )}

      {activeType === 'food' && (
        <div className="space-y-4">
          {(() => {
            const groupedByUser: Record<string, Food[]> = {};
            foods.forEach(food => {
              const username = food.profiles?.name || 'Unknown';
              if (!groupedByUser[username]) groupedByUser[username] = [];
              groupedByUser[username].push(food);
            });

            return Object.entries(groupedByUser).map(([username, userFoods]) => (
              <div key={username} className="space-y-2">
                <h3 className="text-lg font-semibold text-zinc-300">{username}</h3>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                  {userFoods.map(food => (
                    <Card key={food.id} className="p-4 bg-zinc-900 border-zinc-800">
                      <div className="relative mb-3">
                        {food.image_url ? (
                          <img src={food.image_url} alt={food.name} className="w-full h-32 object-cover rounded-lg" />
                        ) : (
                          <div className="w-full h-32 bg-zinc-800 rounded-lg flex items-center justify-center">
                            <Utensils size={32} className="text-zinc-500" />
                          </div>
                        )}
                      </div>
                      <h3 className="font-semibold text-sm mb-2">
                        {food.image_url?.includes('/images/food/')
                          ? food.image_url.split('/').pop()?.replace(/\.[^/.]+$/, '') || food.name
                          : food.name}
                      </h3>
                      {editingPriceItem?.id === food.id && editingPriceItem?.type === 'food' ? (
                        <div className="flex flex-col sm:flex-row gap-2 w-full">
                          <input
                            type="number"
                            value={priceInput}
                            onChange={(e) => setPriceInput(e.target.value)}
                            placeholder="Price"
                            className="flex-1 px-3 py-2 bg-zinc-800 border border-zinc-700 rounded text-white text-sm focus:outline-none focus:border-indigo-500"
                          />
                          <button
                            onClick={() => handleUpdatePrice(food.id, 'food', parseFloat(priceInput))}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded text-sm font-medium transition-colors"
                          >
                            Save
                          </button>
                        </div>
                      ) : (
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-zinc-400">{food.price ? `Rs.${food.price}` : 'No price'}</span>
                          <div className="flex gap-2">
                            <button
                              onClick={() => {
                                setEditingPriceItem({ type: 'food', id: food.id });
                                setPriceInput(food.price?.toString() || '');
                              }}
                              className="text-indigo-400 text-sm hover:text-indigo-300"
                            >
                              Set Price
                            </button>
                            {isUserOwner(food) && (
                              <button
                                onClick={() => handleDeleteFood(food.id)}
                                className="text-red-400 hover:text-red-300 transition-colors"
                                title="Delete"
                              >
                                <Trash2 size={16} />
                              </button>
                            )}
                          </div>
                        </div>
                      )}
                    </Card>
                  ))}
                </div>
              </div>
            ));
          })()}
        </div>
      )}

      {activeType === 'cigarette' && (
        <div className="space-y-4">
          {(() => {
            const groupedByUser: Record<string, Cigarette[]> = {};
            cigarettes.forEach(cig => {
              const username = cig.profiles?.name || 'Unknown';
              if (!groupedByUser[username]) groupedByUser[username] = [];
              groupedByUser[username].push(cig);
            });

            return Object.entries(groupedByUser).map(([username, userCigs]) => (
              <div key={username} className="space-y-2">
                <h3 className="text-lg font-semibold text-zinc-300">{username}</h3>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                  {userCigs.map(cig => (
                    <Card key={cig.id} className="p-4 bg-zinc-900 border-zinc-800">
                      <div className="relative mb-3">
                        {cig.image_url ? (
                          <img src={cig.image_url} alt={cig.name} className="w-full h-32 object-cover rounded-lg" />
                        ) : (
                          <div className="w-full h-32 bg-zinc-800 rounded-lg flex items-center justify-center">
                            <Camera size={32} className="text-zinc-500" />
                          </div>
                        )}
                      </div>
                      <h3 className="font-semibold text-sm mb-2">{cig.name || 'Cigarette Pack'}</h3>
                      {editingPriceItem?.id === cig.id && editingPriceItem?.type === 'cigarette' ? (
                        <div className="flex flex-col sm:flex-row gap-2 w-full">
                          <input
                            type="number"
                            value={priceInput}
                            onChange={(e) => setPriceInput(e.target.value)}
                            placeholder="Price"
                            className="flex-1 px-3 py-2 bg-zinc-800 border border-zinc-700 rounded text-white text-sm focus:outline-none focus:border-indigo-500"
                          />
                          <button
                            onClick={() => handleUpdatePrice(cig.id, 'cigarette', parseFloat(priceInput))}
                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded text-sm font-medium transition-colors"
                          >
                            Save
                          </button>
                        </div>
                      ) : (
                        <div className="flex items-center justify-between">
                          <span className="text-sm text-zinc-400">{cig.price ? `Rs.${cig.price}` : 'No price'}</span>
                          <div className="flex gap-2">
                            <button
                              onClick={() => {
                                setEditingPriceItem({ type: 'cigarette', id: cig.id });
                                setPriceInput(cig.price?.toString() || '');
                              }}
                              className="text-indigo-400 text-sm hover:text-indigo-300"
                            >
                              Set Price
                            </button>
                            {isUserOwner(cig) && (
                              <button
                                onClick={() => handleDeleteCigarette(cig.id)}
                                className="text-red-400 hover:text-red-300 transition-colors"
                                title="Delete"
                              >
                                <Trash2 size={16} />
                              </button>
                            )}
                          </div>
                        </div>
                      )}
                    </Card>
                  ))}
                </div>
              </div>
            ));
          })()}
        </div>
      )}
    </div>
  )}

  {/* User View - Show All Items with User Info */}
  {!isAdmin && (
    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
      {activeType === 'drinks' && drinks.map(drink => (
        <div
          key={drink.id}
          className="relative"
        >
          <Card className="p-4 bg-zinc-900 border-zinc-800 hover:border-indigo-500/50 transition-colors">
            <div className="relative mb-3">
              {drink.image_url ? (
                <img src={drink.image_url} alt={drink.name} className="w-full h-32 object-cover rounded-lg" />
              ) : (
                <div className="w-full h-32 bg-zinc-800 rounded-lg flex items-center justify-center">
                  <Wine size={32} className="text-zinc-500" />
                </div>
              )}
              {isUserOwner(drink) && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    handleDeleteDrink(drink.id);
                  }}
                  className="absolute top-2 right-2 p-1.5 bg-red-500/80 hover:bg-red-600 rounded-full text-white transition-colors"
                  title="Delete"
                >
                  <Trash2 size={14} />
                </button>
              )}
            </div>
            <h3 className="font-semibold text-sm mb-1 line-clamp-1">{drink.name}</h3>
            <p className="text-xs text-zinc-500 mb-1">by {drink.profiles?.name || 'Unknown'}</p>
            {drink.price && <p className="text-sm text-indigo-400">Rs.{drink.price}</p>}
            {!drink.price && <p className="text-xs text-zinc-600">Price not set</p>}
          </Card>
        </div>
      ))}

      {activeType === 'drinks' && drinks.length === 0 && (
        <div className="col-span-full text-center py-12">
          <p className="text-zinc-400">No drinks available. Add drinks to get started!</p>
        </div>
      )}

      {activeType === 'cigarette' && cigarettes.map((cigarette) => (
        <div
          key={cigarette.id}
          className="relative"
        >
          <Card
            className="p-4 bg-zinc-900 border-zinc-800 hover:border-indigo-500/50 transition-colors"
          >
            <div className="relative mb-3">
              <img
                src={cigarette.image_url}
                alt="Cigarette"
                className="w-full h-32 object-cover rounded-lg"
                onError={(e) => {
                  const target = e.target as HTMLImageElement;
                  target.style.display = 'none';
                }}
              />
              {isUserOwner(cigarette) && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    handleDeleteCigarette(cigarette.id);
                  }}
                  className="absolute top-2 right-2 p-1.5 bg-red-500/80 hover:bg-red-600 rounded-full text-white transition-colors"
                  title="Delete"
                >
                  <Trash2 size={14} />
                </button>
              )}
            </div>
            <h3 className="font-semibold text-sm mb-1 line-clamp-1">{cigarette.name || 'Cigarette Pack'}</h3>
            <p className="text-xs text-zinc-500 mb-1">by {cigarette.profiles?.name || 'Unknown'}</p>
            {cigarette.price && <p className="text-sm text-indigo-400">Rs.{cigarette.price}</p>}
            {!cigarette.price && <p className="text-xs text-zinc-600">Price not set</p>}
          </Card>
        </div>
      ))}

      {activeType === 'food' && foods.map((food) => (
        <div
          key={food.id}
          className="relative"
        >
          <Card
            className="p-4 bg-zinc-900 border-zinc-800 hover:border-indigo-500/50 transition-colors"
          >
            <div className="relative mb-3">
              <img
                src={food.image_url}
                alt={food.name}
                className="w-full h-32 object-cover rounded-lg"
                onError={(e) => {
                  const target = e.target as HTMLImageElement;
                  target.style.display = 'none';
                }}
              />
              {isUserOwner(food) && (
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    handleDeleteFood(food.id);
                  }}
                  className="absolute top-2 right-2 p-1.5 bg-red-500/80 hover:bg-red-600 rounded-full text-white transition-colors"
                  title="Delete"
                >
                  <Trash2 size={14} />
                </button>
              )}
            </div>
            <h3 className="font-semibold text-sm mb-1 line-clamp-1">
              {food.image_url?.includes('/images/food/')
                ? food.image_url.split('/').pop()?.replace(/\.[^/.]+$/, '') || food.name
                : food.name}
            </h3>
            <p className="text-xs text-zinc-500 mb-1">by {food.profiles?.name || 'Unknown'}</p>
            {food.price && <p className="text-sm text-indigo-400">Rs.{food.price}</p>}
            {!food.price && <p className="text-xs text-zinc-600">Price not set</p>}
          </Card>
        </div>
      ))}

      {activeType === 'cigarette' && cigarettes.length === 0 && (
        <div className="col-span-full text-center py-12">
          <p className="text-zinc-400">No cigarettes available. Add cigarettes to get started!</p>
        </div>
      )}

      {activeType === 'food' && foods.length === 0 && (
        <div className="col-span-full text-center py-12">
          <p className="text-zinc-400">No food available. Add food to get started!</p>
        </div>
      )}
    </div>
  )}

  {/* Bottom Action Button */}
  <div className="fixed bottom-24 md:bottom-4 left-1/2 -translate-x-1/2 z-40">
    {activeType === 'drinks' && (
      <button
        onClick={() => setIsDrinkModalOpen(true)}
        className="flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 rounded-full shadow-lg hover:from-indigo-500 hover:to-purple-500 transition-all"
      >
        <Plus size={20} className="text-white" />
        <ShinyText
          text="Add Drinks"
          className="text-sm font-bold"
          color="#ffffff"
          shineColor="#c4b5fd"
          speed={2.5}
          style={{ fontFamily: "'Zen Dots', cursive" }}
        />
      </button>
    )}
    {activeType === 'food' && (
      <button
        onClick={() => setIsFoodModalOpen(true)}
        className="flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-orange-500 to-red-500 rounded-full shadow-lg hover:from-orange-400 hover:to-red-400 transition-all"
      >
        <Utensils size={20} className="text-white" />
        <ShinyText
          text="Add Food"
          className="text-sm font-bold"
          color="#ffffff"
          shineColor="#fcd34d"
          speed={2.5}
          style={{ fontFamily: "'Zen Dots', cursive" }}
        />
      </button>
    )}
    {activeType === 'cigarette' && (
      <button
        onClick={() => setIsCigaretteModalOpen(true)}
        className="flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-zinc-600 to-zinc-800 rounded-full shadow-lg hover:from-zinc-500 hover:to-zinc-700 transition-all"
      >
        <Camera size={20} className="text-white" />
        <ShinyText
          text="Add Cigarette"
          className="text-sm font-bold"
          color="#ffffff"
          shineColor="#a1a1aa"
          speed={2.5}
          style={{ fontFamily: "'Zen Dots', cursive" }}
        />
      </button>
    )}
  </div>

  {/* Cart Button */}
  {cartItemCount > 0 && (
    <div className="fixed bottom-4 right-4 z-20">
      <Button
        onClick={() => setActiveSection('checkout')}
        className="relative shadow-lg"
      >
        <ShoppingCart size={20} className="mr-2" />
        Cart
        <span className="ml-2 bg-white text-black px-2 py-0.5 rounded-full text-xs font-bold">
          {cartItemCount}
        </span>
      </Button>
    </div>
  )}
</div>

{/* Modals */ }
        <Modal
          isOpen={isDrinkModalOpen}
          onClose={() => {
            setIsDrinkModalOpen(false);
            setNewDrinkName("");
            setNewDrinkImage("");
            setNewDrinkImagePreview(null);
          }}
          title="Add Drink"
        >
          <form onSubmit={handleAddDrink} className="space-y-4">
            <Input
              label="Drink Name"
              value={newDrinkName}
              onChange={(e) => setNewDrinkName(e.target.value)}
              placeholder="e.g., Kingfisher, Old Monk, etc."
              required
            />

            <div>
              <label className="block text-sm font-medium mb-2">Drink Image</label>
              {newDrinkImagePreview ? (
                <div className="relative">
                  <img src={newDrinkImagePreview} alt="Preview" className="w-full h-48 object-cover rounded-lg mb-2" />
                  <button
                    type="button"
                    onClick={() => {
                      setNewDrinkImagePreview(null);
                      setNewDrinkImage("");
                      if (drinkImageInputRef.current) drinkImageInputRef.current.value = '';
                    }}
                    className="absolute top-2 right-2 p-2 bg-black/70 hover:bg-black/90 rounded-full text-white"
                  >
                    <X size={16} />
                  </button>
                </div>
              ) : (
                <div
                  onClick={() => drinkImageInputRef.current?.click()}
                  className="w-full h-48 border-2 border-dashed border-zinc-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-zinc-600 transition-colors"
                >
                  <ImageIcon size={32} className="text-zinc-500 mb-2" />
                  <p className="text-sm text-zinc-400">Click to upload image</p>
                </div>
              )}
              <input
                ref={drinkImageInputRef}
                type="file"
                accept="image/*"
                onChange={handleDrinkImageUpload}
                className="hidden"
              />
              <Input
                label="Or Image URL (Optional)"
                value={newDrinkImage && !newDrinkImagePreview ? newDrinkImage : ''}
                onChange={(e) => setNewDrinkImage(e.target.value)}
                placeholder="https://example.com/drink-image.jpg"
                className="mt-2"
              />

              {/* Default Drink Images */}
              <div className="mt-4">
                <p className="text-sm text-zinc-400 mb-2">Or select from default images:</p>
                <div className="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                  {['Bacardi.jfif', 'Brocode Beer.jfif', 'Budweiser Beer.jfif', 'Bullet Beer.jfif', 'Carlsberg Beer.jfif', 'Juno.jfif', 'Kingfisher Beer.jfif', 'Manssionhouse.jfif', 'Old Monk.jfif', 'Simba Beer.jfif', 'Tuborg Beer.jpg'].map((imgName) => (
                    <button
                      key={imgName}
                      type="button"
                      onClick={() => {
                        const imagePath = `/images/drinks/${imgName}`;
                        setNewDrinkImage(imagePath);
                        setNewDrinkImagePreview(imagePath);
                        // Set drink name from image name (remove extension and clean up)
                        const drinkName = imgName.replace(/\.[^/.]+$/, '').replace(/([A-Z])/g, ' $1').trim();
                        setNewDrinkName(drinkName);
                      }}
                      className="relative aspect-square border-2 border-zinc-700 rounded-lg overflow-hidden hover:border-indigo-500 transition-colors"
                    >
                      <img
                        src={`/images/drinks/${imgName}`}
                        alt={imgName}
                        className="w-full h-full object-cover"
                        onError={(e) => {
                          const target = e.target as HTMLImageElement;
                          target.style.display = 'none';
                        }}
                      />
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className="flex gap-2">
              <Button type="submit" className="flex-1">
                Add Drink
              </Button>
              <Button
                type="button"
                variant="secondary"
                onClick={() => {
                  setIsDrinkModalOpen(false);
                  setNewDrinkName("");
                  setNewDrinkImage("");
                  setNewDrinkImagePreview(null);
                }}
              >
                Cancel
              </Button>
            </div>
          </form>
        </Modal>

        <Modal
          isOpen={isCigaretteModalOpen}
          onClose={() => {
            setIsCigaretteModalOpen(false);
            setNewCigaretteImage(null);
            setNewCigaretteImagePreview(null);
            setNewCigaretteName("");
          }}
          title="Add Cigarette"
        >
          <form onSubmit={handleAddCigarette} className="space-y-4">
            <Input
              label="Cigarette Name"
              value={newCigaretteName}
              onChange={(e) => setNewCigaretteName(e.target.value)}
              placeholder="e.g., Marlboro, Gold Flake, etc."
              required
            />
            <div>
              <label className="block text-sm font-medium mb-2">Cigarette Image *</label>
              {newCigaretteImagePreview ? (
                <div className="relative">
                  <img src={newCigaretteImagePreview} alt="Preview" className="w-full h-64 object-cover rounded-lg mb-2" />
                  <button
                    type="button"
                    onClick={() => {
                      setNewCigaretteImagePreview(null);
                      setNewCigaretteImage(null);
                      if (cigaretteImageInputRef.current) cigaretteImageInputRef.current.value = '';
                    }}
                    className="absolute top-2 right-2 p-2 bg-black/70 hover:bg-black/90 rounded-full text-white"
                  >
                    <X size={16} />
                  </button>
                </div>
              ) : (
                <div
                  onClick={() => cigaretteImageInputRef.current?.click()}
                  className="w-full h-64 border-2 border-dashed border-zinc-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-zinc-600 transition-colors"
                >
                  <Camera size={48} className="text-zinc-500 mb-2" />
                  <p className="text-sm text-zinc-400">Click to upload cigarette image</p>
                  <p className="text-xs text-zinc-500 mt-1">Upload your cigarette pack photo</p>
                </div>
              )}
              <input
                ref={cigaretteImageInputRef}
                type="file"
                accept="image/*"
                onChange={handleCigaretteImageUpload}
                className="hidden"
              />

              {/* Default Cigarette Images */}
              <div className="mt-4">
                <p className="text-sm text-zinc-400 mb-2">Or select from default images:</p>
                <div className="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                  {['BD Soundar.jfif', 'Classic.jfif', 'Connect.jfif', 'Lights.jfif', 'Malboro.jpg', 'Small.jfif', 'Indie Mini.jfif'].map((imgName) => (
                    <button
                      key={imgName}
                      type="button"
                      onClick={() => {
                        const imagePath = `/images/cigrette/${imgName}`;
                        setNewCigaretteImage(imagePath);
                        setNewCigaretteImagePreview(imagePath);
                        // Set cigarette name from image name (remove extension and clean up)
                        const cigName = imgName.replace(/\.[^/.]+$/, '').replace(/([A-Z])/g, ' $1').trim();
                        setNewCigaretteName(cigName);
                      }}
                      className="relative aspect-square border-2 border-zinc-700 rounded-lg overflow-hidden hover:border-indigo-500 transition-colors"
                    >
                      <img
                        src={`/images/cigrette/${imgName}`}
                        alt={imgName}
                        className="w-full h-full object-cover"
                        onError={(e) => {
                          const target = e.target as HTMLImageElement;
                          target.style.display = 'none';
                        }}
                      />
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className="flex gap-2">
              <Button type="submit" className="flex-1" disabled={!newCigaretteImage || !newCigaretteName.trim()}>
                Add Cigarette
              </Button>
              <Button
                type="button"
                variant="secondary"
                onClick={() => {
                  setIsCigaretteModalOpen(false);
                  setNewCigaretteImage(null);
                  setNewCigaretteImagePreview(null);
                  setNewCigaretteName("");
                }}
              >
                Cancel
              </Button>
            </div>
          </form>
        </Modal>

        <Modal
          isOpen={isFoodModalOpen}
          onClose={() => {
            setIsFoodModalOpen(false);
            setNewFoodImage(null);
            setNewFoodImagePreview(null);
            setNewFoodName("");
          }}
          title="Add Food"
        >
          <form onSubmit={handleAddFood} className="space-y-4">
            <Input
              label="Food Name"
              value={newFoodName}
              onChange={(e) => setNewFoodName(e.target.value)}
              placeholder="e.g., Biryani, Parotta, etc."
              required
            />

            <div>
              <label className="block text-sm font-medium mb-2">Food Image</label>
              {newFoodImagePreview ? (
                <div className="relative">
                  <img src={newFoodImagePreview} alt="Preview" className="w-full h-48 object-cover rounded-lg mb-2" />
                  <button
                    type="button"
                    onClick={() => {
                      setNewFoodImagePreview(null);
                      setNewFoodImage(null);
                      if (foodImageInputRef.current) foodImageInputRef.current.value = '';
                    }}
                    className="absolute top-2 right-2 p-2 bg-black/70 hover:bg-black/90 rounded-full text-white"
                  >
                    <X size={16} />
                  </button>
                </div>
              ) : (
                <div
                  onClick={() => foodImageInputRef.current?.click()}
                  className="w-full h-48 border-2 border-dashed border-zinc-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-zinc-600 transition-colors"
                >
                  <ImageIcon size={32} className="text-zinc-500 mb-2" />
                  <p className="text-sm text-zinc-400">Click to upload image</p>
                </div>
              )}
              <input
                ref={foodImageInputRef}
                type="file"
                accept="image/*"
                onChange={handleFoodImageUpload}
                className="hidden"
              />
              <Input
                label="Or Image URL (Optional)"
                value={newFoodImage && !newFoodImagePreview ? newFoodImage : ''}
                onChange={(e) => setNewFoodImage(e.target.value)}
                placeholder="https://example.com/food-image.jpg"
                className="mt-2"
              />

              {/* Default Food Images */}
              <div className="mt-4">
                <p className="text-sm text-zinc-400 mb-2">Or select from default images:</p>
                <div className="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                  {['Aachi Oorugai.jfif', 'Beef Biriyani.jfif', 'Chicken kabab.jfif', 'Lays.jfif', 'Parotta.jfif'].map((imgName) => (
                    <button
                      key={imgName}
                      type="button"
                      onClick={() => {
                        const imagePath = `/images/food/${imgName}`;
                        setNewFoodImage(imagePath);
                        setNewFoodImagePreview(imagePath);
                        // Set food name from image name (remove extension)
                        const dishName = imgName.replace(/\.[^/.]+$/, '');
                        setNewFoodName(dishName);
                      }}
                      className="relative aspect-square border-2 border-zinc-700 rounded-lg overflow-hidden hover:border-indigo-500 transition-colors"
                    >
                      <img
                        src={`/images/food/${imgName}`}
                        alt={imgName}
                        className="w-full h-full object-cover"
                        onError={(e) => {
                          const target = e.target as HTMLImageElement;
                          target.style.display = 'none';
                        }}
                      />
                    </button>
                  ))}
                </div>
              </div>
            </div>

            <div className="flex gap-2">
              <Button type="submit" className="flex-1" disabled={!newFoodImage || !newFoodName.trim()}>
                Add Food
              </Button>
              <Button
                type="button"
                variant="secondary"
                onClick={() => {
                  setIsFoodModalOpen(false);
                  setNewFoodImage(null);
                  setNewFoodImagePreview(null);
                  setNewFoodName("");
                }}
              >
                Cancel
              </Button>
            </div>
          </form>
        </Modal>
{/* ===== BILL MODAL ===== */ }
<Modal
  isOpen={isBillModalOpen}
  onClose={() => setIsBillModalOpen(false)}
  title={isAdmin ? '🧾 Master Bill' : '🧾 Your Bill'}
>
  <div className="space-y-6">
    {isAdmin ? (
      // ========== ADMIN: MASTER BILL ==========
      (() => {
        // Group items by user
        const userMap: Record<string, {
          name: string;
          items: { name: string; price: number | null; image?: string; type: string }[];
          userId: string;
        }> = {};

        const ensureUser = (userId: string, userName: string) => {
          if (!userMap[userId]) userMap[userId] = { name: userName, items: [], userId: userId };
        };

        drinks.forEach(d => {
          ensureUser(d.suggested_by, d.profiles?.name || 'Unknown');
          userMap[d.suggested_by].items.push({ name: d.name, price: d.price || null, image: d.image_url, type: '🍺' });
        });
        foods.forEach(f => {
          ensureUser(f.added_by, f.profiles?.name || 'Unknown');
          userMap[f.added_by].items.push({ name: f.name, price: f.price || null, image: f.image_url, type: '🍕' });
        });
        cigarettes.forEach(c => {
          ensureUser(c.added_by, c.profiles?.name || 'Unknown');
          userMap[c.added_by].items.push({ name: c.name, price: c.price || null, image: c.image_url, type: '🚬' });
        });

        const entries = Object.entries(userMap);
        let grandTotal = 0;
        entries.forEach(([, u]) => {
          u.items.forEach(item => { grandTotal += item.price || 0; });
        });

        if (entries.length === 0) {
          return <p className="text-zinc-400 text-center py-8">No items ordered yet.</p>;
        }

        return (
          <>
            <div className="max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar space-y-4">
              {entries.map(([userId, userData]) => {
                const userTotal = userData.items.reduce((s, i) => s + (i.price || 0), 0);
                const isConfirmed = billConfirmations[userId];

                return (
                  <div key={userId} className="space-y-3 p-3 rounded-xl bg-zinc-900/50 border border-zinc-800">
                    <div className="flex items-center justify-between">
                      <h3 className="font-bold text-white text-lg flex items-center gap-2">
                        {userData.name}
                        {isConfirmed && <CheckCircle2 size={16} className="text-emerald-500" />}
                      </h3>
                      <span className="text-indigo-400 font-bold">₹{userTotal}</span>
                    </div>
                    <div className="space-y-2">
                      {userData.items.map((item, idx) => (
                        <PixelCard key={idx} variant="blue" className="!h-auto !w-full !aspect-auto !rounded-lg bg-black/40">
                          <div className="flex items-center gap-3 w-full p-2 relative z-10">
                            {item.image ? (
                              <img src={item.image} alt={item.name} className="w-8 h-8 rounded-md object-cover flex-shrink-0" />
                            ) : (
                              <div className="w-8 h-8 rounded-md bg-zinc-800 flex items-center justify-center flex-shrink-0 text-sm">
                                {item.type}
                              </div>
                            )}
                            <div className="flex-1 min-w-0">
                              <p className="text-white text-xs font-medium truncate">{item.type} {item.name}</p>
                            </div>
                            <span className={`text-xs font-bold flex-shrink-0 ${item.price ? 'text-emerald-400' : 'text-amber-400'}`}>
                              {item.price ? `₹${item.price}` : 'Pending'}
                            </span>
                          </div>
                        </PixelCard>
                      ))}
                    </div>
                    <div className="pt-2 flex justify-end">
                      <button
                        onClick={async () => {
                          try {
                            if (isConfirmed) {
                              await billService.unconfirmBill(spot.id, userId);
                            } else {
                              await billService.confirmBill(spot.id, userId);
                            }
                            fetchData(); // Refresh to show update
                          } catch (e) {
                            console.error('Error toggling bill:', e);
                          }
                        }}
                        className={`px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider transition-colors border ${isConfirmed
                          ? 'bg-emerald-500/10 border-emerald-500/50 text-emerald-400 hover:bg-emerald-500/20'
                          : 'bg-zinc-800 border-zinc-700 text-zinc-400 hover:bg-zinc-700 hover:text-white'
                          }`}
                      >
                        {isConfirmed ? 'Confirmed ✓' : 'Confirm Bill'}
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Grand Total */}
            <div className="bg-gradient-to-r from-indigo-900/50 to-purple-900/50 border border-indigo-500/30 rounded-xl p-4 mt-4 sticky bottom-0 z-20 backdrop-blur-md">
              <div className="flex items-center justify-between">
                <span className="text-white font-bold text-lg">Grand Total</span>
                <span className="text-2xl font-black text-indigo-300">₹{grandTotal}</span>
              </div>
            </div>
          </>
        );
      })()
    ) : (
      // ========== USER: YOUR BILL ==========
      (() => {
        const myItems: { name: string; price: number | null; image?: string; type: string }[] = [];

        drinks.filter(d => d.suggested_by === currentUserUUID).forEach(d => {
          myItems.push({ name: d.name, price: d.price || null, image: d.image_url, type: '🍺' });
        });
        foods.filter(f => f.added_by === currentUserUUID).forEach(f => {
          myItems.push({ name: f.name, price: f.price || null, image: f.image_url, type: '🍕' });
        });
        cigarettes.filter(c => c.added_by === currentUserUUID).forEach(c => {
          myItems.push({ name: c.name, price: c.price || null, image: c.image_url, type: '🚬' });
        });

        const myTotal = myItems.reduce((s, i) => s + (i.price || 0), 0);
        const isConfirmed = currentUserUUID ? billConfirmations[currentUserUUID] : false;
        const isSponsored = !!spotSponsor;

        if (myItems.length === 0) {
          return <p className="text-zinc-400 text-center py-8">You haven't ordered anything yet.</p>;
        }

        return (
          <>
            <div className="space-y-3">
              {isSponsored && (
                <div className="p-3 rounded-xl bg-amber-500/10 border border-amber-500/30 flex items-center gap-3">
                  <Crown size={24} className="text-amber-400 flex-shrink-0" />
                  <div>
                    <p className="text-amber-200 text-xs font-bold uppercase">Sponsored Event</p>
                    <p className="text-white text-xs">
                      Bill covered by <span className="font-bold text-amber-400">{spotSponsor.profiles?.name}</span>
                    </p>
                  </div>
                </div>
              )}

              <div className="space-y-2 max-h-[50vh] overflow-y-auto custom-scrollbar pr-1">
                {myItems.map((item, idx) => (
                  <PixelCard key={idx} variant="blue" className="!h-auto !w-full !aspect-auto !rounded-lg">
                    <div className="flex items-center gap-3 w-full p-3 relative z-10">
                      {item.image ? (
                        <img src={item.image} alt={item.name} className="w-10 h-10 rounded-lg object-cover flex-shrink-0" />
                      ) : (
                        <div className="w-10 h-10 rounded-lg bg-zinc-800 flex items-center justify-center flex-shrink-0 text-lg">
                          {item.type}
                        </div>
                      )}
                      <div className="flex-1 min-w-0">
                        <p className="text-white text-sm font-medium truncate">{item.type} {item.name}</p>
                      </div>
                      <span className={`text-sm font-bold flex-shrink-0 ${item.price ? 'text-emerald-400' : 'text-amber-400'}`}>
                        {item.price ? `₹${item.price}` : 'Pending'}
                      </span>
                    </div>
                  </PixelCard>
                ))}
              </div>
            </div>

            {/* Total */}
            <div className="bg-gradient-to-r from-indigo-900/50 to-purple-900/50 border border-indigo-500/30 rounded-xl p-4">
              <div className="flex items-center justify-between">
                <span className="text-white font-bold text-lg">Your Total</span>
                <div className="text-right">
                  <span className={`text-2xl font-black ${isSponsored ? 'text-amber-400 line-through Decoration-2' : 'text-indigo-300'}`}>₹{myTotal}</span>
                  {isSponsored && <span className="block text-emerald-400 font-bold text-sm">₹0 (Sponsored)</span>}
                </div>
              </div>
            </div>

            {/* Pay Button (Only if not sponsored and bill confirmed or just standard flow) */}
            {!isSponsored && (
              <button
                onClick={() => {
                  setIsBillModalOpen(false);
                  navigate('/dashboard/payment');
                }}
                className="w-full py-4 bg-indigo-600 hover:bg-indigo-500 active:scale-[0.98] transition-all rounded-xl font-black uppercase tracking-widest text-white shadow-lg shadow-indigo-600/20 flex items-center justify-center gap-2"
              >
                Pay Bill <ArrowLeft className="rotate-180" size={18} />
              </button>
            )}
          </>
        );
      })()
    )}

    {/* BroCode Management Seal */}
    <div className="flex flex-col items-center pt-8 relative">
      {/* Green Tick Overlay */}
      {!isAdmin && currentUserUUID && billConfirmations[currentUserUUID] && (
        <div className="absolute top-0 z-20 animate-bounce">
          <div className="bg-emerald-500 text-white rounded-full p-2 border-4 border-black shadow-lg shadow-emerald-500/30">
            <Check size={32} strokeWidth={4} />
          </div>
        </div>
      )}

      <div className="relative opacity-80 hover:opacity-100 transition-opacity">
        <CircularText
          text="BROCODE✦MANAGEMENT✦"
          onHover="speedUp"
          spinDuration={20}
          className="text-indigo-400/60"
        />
        <div className="absolute inset-0 flex items-center justify-center">
          <div className="w-12 h-12 rounded-full bg-indigo-500/20 border border-indigo-500/40 flex items-center justify-center">
            <span className="text-lg">🍻</span>
          </div>
        </div>
      </div>
      <p className="text-[10px] text-zinc-600 mt-2 font-mono">Verified by BroCode Management</p>
    </div>
  </div>
</Modal>
      </div >
      </>
    );
  }
  */

// CHECKOUT SECTION
if (activeSection === 'checkout') {
  return (
    <div className="min-h-screen bg-black text-white pb-24">
      {/* Header */}
      <div className="sticky top-0 z-10 bg-black border-b border-zinc-800 px-4 py-3">
        <div className="flex items-center justify-between max-w-7xl mx-auto">
          <button
            onClick={() => setActiveSection('browse')}
            className="p-2 hover:bg-zinc-900 rounded-lg"
          >
            <ArrowLeft size={20} />
          </button>
          <div className="flex items-center gap-2">
            <span className="text-sm font-medium text-zinc-400">{spot.location}</span>
            <span className="text-zinc-600">â€¢â€¢â€¢</span>
            <span className="text-sm font-medium text-zinc-400">12 Bar</span>
          </div>
          <button className="p-2 hover:bg-zinc-900 rounded-lg">
            <Trash2 size={20} />
          </button>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-6">
        <h1 className="text-2xl md:text-3xl font-bold mb-6">Checkout</h1>

        {/* Order List */}
        <div className="space-y-4 mb-6">
          {userSelections.map(selection => (
            <Card key={selection.id} className="p-4 bg-zinc-900 border-zinc-800">
              <div className="flex items-center gap-4">
                {selection.drink_brand?.image_url ? (
                  <img
                    src={selection.drink_brand.image_url}
                    alt={selection.drink_brand.name}
                    className="w-16 h-16 object-cover rounded-lg"
                  />
                ) : (
                  <div className="w-16 h-16 bg-zinc-800 rounded-lg flex items-center justify-center">
                    <Wine size={24} className="text-zinc-500" />
                  </div>
                )}
                <div className="flex-1">
                  <h3 className="font-semibold">{selection.drink_brand?.name}</h3>
                  <p className="text-sm text-zinc-400">Rs.{selection.unit_price} each</p>
                </div>
                <div className="flex items-center gap-3">
                  <button
                    onClick={() => handleUpdateQuantity(selection, selection.quantity - 1)}
                    className="p-2 bg-zinc-800 rounded hover:bg-zinc-700"
                  >
                    <Minus size={16} />
                  </button>
                  <span className="font-bold w-8 text-center">{selection.quantity}</span>
                  <button
                    onClick={() => handleUpdateQuantity(selection, selection.quantity + 1)}
                    className="p-2 bg-zinc-800 rounded hover:bg-zinc-700"
                  >
                    <Plus size={16} />
                  </button>
                  <span className="font-bold text-lg w-20 text-right">Rs.{selection.total_price}</span>
                  <button
                    onClick={() => handleRemoveSelection(selection.id)}
                    className="p-2 text-red-400 hover:bg-red-400/10 rounded"
                  >
                    <Trash2 size={16} />
                  </button>
                </div>
              </div>
            </Card>
          ))}
        </div>

        {/* Comment Field */}
        <div className="mb-6">
          <Input
            label="Comment on the order:"
            value={orderComment}
            onChange={(e) => setOrderComment(e.target.value)}
            placeholder="No Comment"
            className="bg-zinc-900 border-zinc-800"
          />
        </div>

        {/* Total Price */}
        <div className="mb-6">
          <div className="flex justify-between items-center p-4 bg-zinc-900 rounded-lg border border-zinc-800">
            <span className="text-lg font-semibold">Total price</span>
            <span className="text-2xl font-bold text-indigo-400">Rs.{totalCartAmount.toFixed(2)}</span>
          </div>
        </div>

        {/* Pay Now Button */}
        <Button
          onClick={handlePayNow}
          className="w-full py-4 text-lg font-bold bg-black text-white border-2 border-white hover:bg-white hover:text-black transition-colors"
        >
          <ShoppingCart size={20} className="mr-2" />
          Pay Now
        </Button>
      </div>

      {/* Modals */}
      <Modal
        isOpen={isDrinkModalOpen}
        onClose={() => {
          setIsDrinkModalOpen(false);
          setNewDrinkName("");
          setNewDrinkImage("");
          setNewDrinkImagePreview(null);
        }}
        title="Add Drink"
      >
        <form onSubmit={handleAddDrink} className="space-y-4">
          <Input
            label="Drink Name"
            value={newDrinkName}
            onChange={(e) => setNewDrinkName(e.target.value)}
            placeholder="e.g., Kingfisher, Old Monk, etc."
            required
          />

          <div>
            <label className="block text-sm font-medium mb-2">Drink Image</label>
            {newDrinkImagePreview ? (
              <div className="relative">
                <img src={newDrinkImagePreview} alt="Preview" className="w-full h-48 object-cover rounded-lg mb-2" />
                <button
                  type="button"
                  onClick={() => {
                    setNewDrinkImagePreview(null);
                    setNewDrinkImage("");
                    if (drinkImageInputRef.current) drinkImageInputRef.current.value = '';
                  }}
                  className="absolute top-2 right-2 p-2 bg-black/70 hover:bg-black/90 rounded-full text-white"
                >
                  <X size={16} />
                </button>
              </div>
            ) : (
              <div
                onClick={() => drinkImageInputRef.current?.click()}
                className="w-full h-48 border-2 border-dashed border-zinc-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-zinc-600 transition-colors"
              >
                <ImageIcon size={32} className="text-zinc-500 mb-2" />
                <p className="text-sm text-zinc-400">Click to upload image</p>
              </div>
            )}
            <input
              ref={drinkImageInputRef}
              type="file"
              accept="image/*"
              onChange={handleDrinkImageUpload}
              className="hidden"
            />
            <Input
              label="Or Image URL (Optional)"
              value={newDrinkImage && !newDrinkImagePreview ? newDrinkImage : ''}
              onChange={(e) => setNewDrinkImage(e.target.value)}
              placeholder="https://example.com/drink-image.jpg"
              className="mt-2"
            />

            {/* Default Drink Images */}
            <div className="mt-4">
              <p className="text-sm text-zinc-400 mb-2">Or select from default images:</p>
              <div className="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                {['Bacardi.jfif', 'Brocode Beer.jfif', 'Budweiser Beer.jfif', 'Bullet Beer.jfif', 'Carlsberg Beer.jfif', 'Juno.jfif', 'Kingfisher Beer.jfif', 'Manssionhouse.jfif', 'Old Monk.jfif', 'Simba Beer.jfif', 'Tuborg Beer.jpg'].map((imgName) => (
                  <button
                    key={imgName}
                    type="button"
                    onClick={() => {
                      const imagePath = `/images/drinks/${imgName}`;
                      setNewDrinkImage(imagePath);
                      setNewDrinkImagePreview(imagePath);
                      // Set drink name from image name (remove extension and clean up)
                      const drinkName = imgName.replace(/\.[^/.]+$/, '').replace(/([A-Z])/g, ' $1').trim();
                      setNewDrinkName(drinkName);
                    }}
                    className="relative aspect-square border-2 border-zinc-700 rounded-lg overflow-hidden hover:border-indigo-500 transition-colors"
                  >
                    <img
                      src={`/images/drinks/${imgName}`}
                      alt={imgName}
                      className="w-full h-full object-cover"
                      onError={(e) => {
                        const target = e.target as HTMLImageElement;
                        target.style.display = 'none';
                      }}
                    />
                  </button>
                ))}
              </div>
            </div>
          </div>

          <div className="flex gap-2">
            <Button type="submit" className="flex-1">
              Add Drink
            </Button>
            <Button
              type="button"
              variant="secondary"
              onClick={() => {
                setIsDrinkModalOpen(false);
                setNewDrinkName("");
                setNewDrinkImage("");
                setNewDrinkImagePreview(null);
              }}
            >
              Cancel
            </Button>
          </div>
        </form>
      </Modal>

      <Modal
        isOpen={isCigaretteModalOpen}
        onClose={() => {
          setIsCigaretteModalOpen(false);
          setNewCigaretteImage(null);
          setNewCigaretteImagePreview(null);
          setNewCigaretteName("");
        }}
        title="Add Cigarette"
      >
        <form onSubmit={handleAddCigarette} className="space-y-4">
          <Input
            label="Cigarette Name"
            value={newCigaretteName}
            onChange={(e) => setNewCigaretteName(e.target.value)}
            placeholder="e.g., Marlboro, Gold Flake, etc."
            required
          />
          <div>
            <label className="block text-sm font-medium mb-2">Cigarette Image *</label>
            {newCigaretteImagePreview ? (
              <div className="relative">
                <img src={newCigaretteImagePreview} alt="Preview" className="w-full h-64 object-cover rounded-lg mb-2" />
                <button
                  type="button"
                  onClick={() => {
                    setNewCigaretteImagePreview(null);
                    setNewCigaretteImage(null);
                    if (cigaretteImageInputRef.current) cigaretteImageInputRef.current.value = '';
                  }}
                  className="absolute top-2 right-2 p-2 bg-black/70 hover:bg-black/90 rounded-full text-white"
                >
                  <X size={16} />
                </button>
              </div>
            ) : (
              <div
                onClick={() => cigaretteImageInputRef.current?.click()}
                className="w-full h-64 border-2 border-dashed border-zinc-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-zinc-600 transition-colors"
              >
                <Camera size={48} className="text-zinc-500 mb-2" />
                <p className="text-sm text-zinc-400">Click to upload cigarette image</p>
                <p className="text-xs text-zinc-500 mt-1">Upload your cigarette pack photo</p>
              </div>
            )}
            <input
              ref={cigaretteImageInputRef}
              type="file"
              accept="image/*"
              onChange={handleCigaretteImageUpload}
              className="hidden"
              required
            />
          </div>

          <div className="flex gap-2">
            <Button type="submit" className="flex-1" disabled={!newCigaretteImage || !newCigaretteName.trim()}>
              Add Cigarette
            </Button>
            <Button
              type="button"
              variant="secondary"
              onClick={() => {
                setIsCigaretteModalOpen(false);
                setNewCigaretteImage(null);
                setNewCigaretteImagePreview(null);
                setNewCigaretteName("");
              }}
            >
              Cancel
            </Button>
          </div>
        </form>
      </Modal>
    </div>
  );
}

// PRODUCT DETAIL SECTION
if (activeSection === 'detail' && selectedProduct) {
  const isDrinkBrand = 'base_price' in selectedProduct;
  const isDrink = 'votes' in selectedProduct && !isDrinkBrand;
  const isFood = 'name' in selectedProduct && !isDrinkBrand && !isDrink && 'added_by' in selectedProduct;
  const [showFullDescription, setShowFullDescription] = useState(false);
  const [detailQuantity, setDetailQuantity] = useState(1);

  const existingSelection = isDrinkBrand
    ? userSelections.find(s => s.drink_brand_id === selectedProduct.id)
    : null;

  return (
    <div className="min-h-screen bg-black text-white pb-24">
      {/* Header */}
      <div className="sticky top-0 z-10 bg-black border-b border-zinc-800 px-4 py-3">
        <div className="flex items-center justify-between max-w-7xl mx-auto">
          <button
            onClick={() => setActiveSection('browse')}
            className="p-2 hover:bg-zinc-900 rounded-lg"
          >
            <ArrowLeft size={20} />
          </button>
          <button className="p-2 hover:bg-zinc-900 rounded-lg">
            <Menu size={20} />
          </button>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 py-6 space-y-6">
        {/* Product Image */}
        <div className="flex justify-center">
          <div className="w-64 h-64 rounded-full bg-zinc-900 p-8 flex items-center justify-center">
            {isDrinkBrand && (selectedProduct as DrinkBrand).image_url ? (
              <img
                src={(selectedProduct as DrinkBrand).image_url}
                alt={(selectedProduct as DrinkBrand).name}
                className="w-full h-full object-contain"
              />
            ) : isDrink && (selectedProduct as Drink).image_url ? (
              <img
                src={(selectedProduct as Drink).image_url}
                alt={(selectedProduct as Drink).name}
                className="w-full h-full object-contain"
              />
            ) : isFood && (selectedProduct as Food).image_url ? (
              <img
                src={(selectedProduct as Food).image_url}
                alt={(selectedProduct as Food).name}
                className="w-full h-full object-contain"
              />
            ) : (selectedProduct as Cigarette).image_url ? (
              <img
                src={(selectedProduct as Cigarette).image_url}
                alt="Cigarette"
                className="w-full h-full object-contain"
              />
            ) : (
              <Wine size={64} className="text-zinc-500" />
            )}
          </div>
        </div>

        {/* Product Name */}
        <h1 className="text-3xl font-bold text-center">
          {isDrinkBrand
            ? (selectedProduct as DrinkBrand).name
            : isDrink
              ? (selectedProduct as Drink).name
              : isFood
                ? (selectedProduct as Food).name
                : (selectedProduct as Cigarette).name || 'Cigarette Pack'}
        </h1>

        {/* Price */}
        {isDrinkBrand && (
          <p className="text-2xl font-bold text-center text-indigo-400">
            Rs.{(selectedProduct as DrinkBrand).base_price}
          </p>
        )}

        {/* Quantity Stepper */}
        {isDrinkBrand && (
          <div className="flex items-center justify-center gap-4">
            <button
              onClick={() => setDetailQuantity(Math.max(1, detailQuantity - 1))}
              className="p-2 bg-zinc-900 rounded-lg hover:bg-zinc-800 border border-zinc-800"
            >
              <Minus size={20} />
            </button>
            <span className="text-2xl font-bold w-12 text-center">{detailQuantity}</span>
            <button
              onClick={() => setDetailQuantity(detailQuantity + 1)}
              className="p-2 bg-zinc-900 rounded-lg hover:bg-zinc-800 border border-zinc-800"
            >
              <Plus size={20} />
            </button>
          </div>
        )}

        {/* Description */}
        {isDrinkBrand && (selectedProduct as DrinkBrand).description && (
          <div className="space-y-2">
            <p className="text-zinc-400 leading-relaxed">
              {showFullDescription
                ? (selectedProduct as DrinkBrand).description
                : (selectedProduct as DrinkBrand).description?.substring(0, 150)}
              {(selectedProduct as DrinkBrand).description && (selectedProduct as DrinkBrand).description!.length > 150 && !showFullDescription && '...'}
            </p>
            {(selectedProduct as DrinkBrand).description && (selectedProduct as DrinkBrand).description!.length > 150 && (
              <button
                onClick={() => setShowFullDescription(!showFullDescription)}
                className="text-indigo-400 hover:text-indigo-300 text-sm font-medium"
              >
                {showFullDescription ? 'Read less' : 'Read more'}
              </button>
            )}
          </div>
        )}

        {/* Ratings / Reviews */}
        <div className="flex items-center gap-2 justify-center">
          <div className="flex gap-1">
            {[1, 2, 3, 4, 5].map((star) => (
              <Star key={star} size={20} className="text-zinc-600 fill-zinc-600" />
            ))}
          </div>
          <span className="text-zinc-400 text-sm">28 reviews</span>
        </div>

        {/* Add to Cart Button */}
        {isDrinkBrand && (
          <Button
            onClick={() => {
              handleAddToCart(selectedProduct as DrinkBrand, detailQuantity);
              setActiveSection('browse');
            }}
            className="w-full py-4 text-lg font-bold"
          >
            <Plus size={20} className="mr-2" />
            Add to Cart
          </Button>
        )}
      </div>

      {/* Floating Action Buttons */}
      <div className="fixed bottom-4 right-4 z-20 flex gap-2">
        <Button
          onClick={() => setIsCigaretteModalOpen(true)}
          variant="secondary"
          className="shadow-lg"
        >
          <Camera size={16} className="mr-2" />
          Add Cigarette
        </Button>
        <Button
          onClick={() => setIsDrinkModalOpen(true)}
          className="shadow-lg"
        >
          <Plus size={16} className="mr-2" />
          Suggest Drink
        </Button>
      </div>
    </div>
  );
}

return (
  <>
    {/* ADD DRINK MODAL */}
    <Modal
      isOpen={isDrinkModalOpen}
      onClose={() => {
        setIsDrinkModalOpen(false);
        setNewDrinkName("");
        setNewDrinkImage("");
        setNewDrinkImagePreview(null);
      }}
      title="Add Drink"
    >
      <form onSubmit={handleAddDrink} className="space-y-4">
        <Input
          label="Drink Name"
          value={newDrinkName}
          onChange={(e) => setNewDrinkName(e.target.value)}
          placeholder="e.g., Kingfisher, Old Monk, etc."
          required
        />

        <div>
          <label className="block text-sm font-medium mb-2">Drink Image</label>
          {newDrinkImagePreview ? (
            <div className="relative">
              <img src={newDrinkImagePreview} alt="Preview" className="w-full h-48 object-cover rounded-lg mb-2" />
              <button
                type="button"
                onClick={() => {
                  setNewDrinkImagePreview(null);
                  setNewDrinkImage("");
                  if (drinkImageInputRef.current) drinkImageInputRef.current.value = '';
                }}
                className="absolute top-2 right-2 p-2 bg-black/70 hover:bg-black/90 rounded-full text-white"
              >
                <X size={16} />
              </button>
            </div>
          ) : (
            <div
              onClick={() => drinkImageInputRef.current?.click()}
              className="w-full h-48 border-2 border-dashed border-zinc-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-zinc-600 transition-colors"
            >
              <ImageIcon size={32} className="text-zinc-500 mb-2" />
              <p className="text-sm text-zinc-400">Click to upload image</p>
            </div>
          )}
          <input
            ref={drinkImageInputRef}
            type="file"
            accept="image/*"
            onChange={handleDrinkImageUpload}
            className="hidden"
          />
          <Input
            label="Or Image URL (Optional)"
            value={newDrinkImage && !newDrinkImagePreview ? newDrinkImage : ''}
            onChange={(e) => setNewDrinkImage(e.target.value)}
            placeholder="https://example.com/drink-image.jpg"
            className="mt-2"
          />
        </div>

        <div className="flex gap-2">
          <Button type="submit" className="flex-1">
            Add Drink
          </Button>
          <Button
            type="button"
            variant="secondary"
            onClick={() => {
              setIsDrinkModalOpen(false);
              setNewDrinkName("");
              setNewDrinkImage("");
              setNewDrinkImagePreview(null);
            }}
          >
            Cancel
          </Button>
        </div>
      </form>
    </Modal>

    {/* ADD CIGARETTE MODAL */}
    <Modal
      isOpen={isCigaretteModalOpen}
      onClose={() => {
        setIsCigaretteModalOpen(false);
        setNewCigaretteImage(null);
        setNewCigaretteImagePreview(null);
      }}
      title="Add Cigarette"
    >
      <form onSubmit={handleAddCigarette} className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-2">Cigarette Image *</label>
          {newCigaretteImagePreview ? (
            <div className="relative">
              <img src={newCigaretteImagePreview} alt="Preview" className="w-full h-64 object-cover rounded-lg mb-2" />
              <button
                type="button"
                onClick={() => {
                  setNewCigaretteImagePreview(null);
                  setNewCigaretteImage(null);
                  if (cigaretteImageInputRef.current) cigaretteImageInputRef.current.value = '';
                }}
                className="absolute top-2 right-2 p-2 bg-black/70 hover:bg-black/90 rounded-full text-white"
              >
                <X size={16} />
              </button>
            </div>
          ) : (
            <div
              onClick={() => cigaretteImageInputRef.current?.click()}
              className="w-full h-64 border-2 border-dashed border-zinc-700 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:border-zinc-600 transition-colors"
            >
              <Camera size={48} className="text-zinc-500 mb-2" />
              <p className="text-sm text-zinc-400">Click to upload cigarette image</p>
              <p className="text-xs text-zinc-500 mt-1">Upload your cigarette pack photo</p>
            </div>
          )}
          <input
            ref={cigaretteImageInputRef}
            type="file"
            accept="image/*"
            onChange={handleCigaretteImageUpload}
            className="hidden"
            required
          />
        </div>

        <div className="flex gap-2">
          <Button type="submit" className="flex-1" disabled={!newCigaretteImage}>
            Add Cigarette
          </Button>
          <Button
            type="button"
            variant="secondary"
            onClick={() => {
              setIsCigaretteModalOpen(false);
              setNewCigaretteImage(null);
              setNewCigaretteImagePreview(null);
            }}
          >
            Cancel
          </Button>
        </div>
      </form>
    </Modal>
  </>
);
  }
return null;
};

export default DrinksPage;

